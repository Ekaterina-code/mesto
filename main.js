(()=>{"use strict";function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var t=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.baseUrl=e.baseUrl,this.headers=e.headers}var n,r;return n=t,(r=[{key:"getUserInfo",value:function(){return this._sendRequest("users/me","GET").then(this._toUserInfo)}},{key:"getInitialCards",value:function(){var e=this;return this._sendRequest("cards","GET").then((function(t){return t.map(e._toCardInfo.bind(e)).reverse()}))}},{key:"setUserInfo",value:function(e){var t=JSON.stringify({name:e.name,about:e.info});return this._sendRequest("users/me","PATCH",t).then(this._toUserInfo)}},{key:"setUserAvatar",value:function(e){var t=JSON.stringify({avatar:e});return this._sendRequest("users/me/avatar","PATCH",t)}},{key:"addCard",value:function(e){var t=JSON.stringify({name:e.name,link:e.link});return this._sendRequest("cards","POST",t).then(this._toCardInfo.bind(this))}},{key:"setCardLikeState",value:function(e,t){var n=t?"PUT":"DELETE";return this._sendRequest("cards/likes/".concat(e),n).then(this._getLikeUserIds.bind(this))}},{key:"removeCard",value:function(e){return this._sendRequest("cards/".concat(e),"DELETE")}},{key:"_toUserInfo",value:function(e){return{_id:e._id,name:e.name,info:e.about,avatar:e.avatar}}},{key:"_toCardInfo",value:function(e){return{_id:e._id,name:e.name,link:e.link,ownerId:e.owner._id,likes:this._getLikeUserIds(e)}}},{key:"_getLikeUserIds",value:function(e){return e.likes.map((function(e){return e._id}))}},{key:"_sendRequest",value:function(e,t,n){return fetch("".concat(this.baseUrl,"/").concat(e),{headers:this.headers,method:t,body:n}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}}])&&e(n.prototype,r),t}();function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var r=function(){function e(t,n,r,i,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var u=document.querySelector(t).content;this.element=u.querySelector(".element").cloneNode(!0),this.titleElement=this.element.querySelector(".element__title"),this.likeElement=this.element.querySelector(".element__like"),this.likeCounterElement=this.element.querySelector(".element__like-counter"),this.deleteElement=this.element.querySelector(".element__delete"),this.imageElement=this.element.querySelector(".element__image"),this._id=n._id,this.link=n.link,this.name=n.name,this.likesInfo=n.likesInfo,this.isDeleteEnable=n.isDeleteEnable,this.handleCardClick=r,this.handleLikeClick=i,this.handleDelClick=o}var t,r;return t=e,(r=[{key:"render",value:function(){return this.isDeleteEnable?this._setDelEventListener():this.deleteElement.remove(),this.element.id="card_"+this._id,this._setLikeEventListener(),this._setImageEventListener(),this._setImage(),this._setTitle(),this._renderLike(),this.element}},{key:"setLikeInfo",value:function(e){this.likesInfo=e,this._renderLike()}},{key:"_setImage",value:function(){this.imageElement.src=this.link,this.imageElement.alt=this.name}},{key:"_setTitle",value:function(){this.titleElement.textContent=this.name}},{key:"_setLikeEventListener",value:function(){this.likeElement.addEventListener("click",this._handleLikeClick.bind(this))}},{key:"_handleLikeClick",value:function(){var e=!this.likesInfo.state;this.likeElement.classList.toggle("element__like_active",e),this.handleLikeClick(this,e)}},{key:"_renderLike",value:function(){this.likeElement.classList.toggle("element__like_active",this.likesInfo.state),this.likeCounterElement.classList.toggle("element__like-counter_visible",this.likesInfo.count>0),this.likeCounterElement.textContent=this.likesInfo.count}},{key:"_setDelEventListener",value:function(){var e=this;this.deleteElement.addEventListener("click",(function(){return e._handleDelClick()}))}},{key:"_handleDelClick",value:function(){this.handleDelClick(this._id)}},{key:"_setImageEventListener",value:function(){var e=this;this.imageElement.addEventListener("click",(function(){return e._handleCardClick()}))}},{key:"_handleCardClick",value:function(){this.handleCardClick(this.link,this.name)}}])&&n(t.prototype,r),e}();function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.settings=t,this.form=n,this.button=this.form.querySelector(this.settings.submitButtonSelector),this.inputs=Array.from(this.form.querySelectorAll(this.settings.inputSelector)).filter((function(e){return"hidden"!=e.type}))}var t,n;return t=e,(n=[{key:"enableValidation",value:function(){var e=this;this.inputs.forEach((function(t){t.addEventListener("input",(function(){return e._validate(t)}))})),this.form.addEventListener("reset",(function(){return e._resetFormValidation()})),this._validateForm()}},{key:"_resetFormValidation",value:function(){var e=this;this.inputs.forEach((function(t){var n=e._getErrorElement(t);e._hideInputError(n,t)})),this._validateForm()}},{key:"_validate",value:function(e){var t=this._getErrorElement(e);e.validity.valid?this._hideInputError(t,e):this._showInputError(t,e),this._validateForm()}},{key:"_getErrorElement",value:function(e){return this.form.querySelector(".".concat(e.id,"-error"))}},{key:"_showInputError",value:function(e,t){t.classList.add(this.settings.inputErrorClass),e.classList.add(this.settings.errorClass),e.textContent=t.validationMessage}},{key:"_hideInputError",value:function(e,t){t.classList.remove(this.settings.inputErrorClass),e.classList.remove(this.settings.errorClass),e.textContent=""}},{key:"_validateForm",value:function(){var e=this._validateInputs();this._setSubmitButtonState(!e)}},{key:"_setSubmitButtonState",value:function(e){this.button.disabled=e,this.button.classList.toggle(this.settings.inactiveButtonClass,e)}},{key:"_validateInputs",value:function(){return this.inputs.reduce((function(e,t){return e&&t.validity.valid}),!0)}}])&&i(t.prototype,n),e}();function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.popup=document.querySelector(t),this._handleEscCloseWithBindedContext=this._handleEscClose.bind(this)}var t,n;return t=e,(n=[{key:"open",value:function(){this.popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscCloseWithBindedContext)}},{key:"close",value:function(){this.popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscCloseWithBindedContext)}},{key:"_handleEscClose",value:function(e){"Escape"===e.key&&this.close()}},{key:"setEventListeners",value:function(){var e=this;this.popup.addEventListener("click",(function(t){t.target.classList.contains("popup__overlay")&&e.close(),t.target.classList.contains("popup__close")&&e.close()}))}}])&&u(t.prototype,n),e}();function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=h(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}})(e,t,n||e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var d=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(u,e);var t,n,r,i,o=(r=u,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=h(r);if(i){var n=h(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return p(this,e)});function u(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(n=o.call(this,e)).submitCallback=t,n.form=n.popup.querySelector(".popup__form"),n.inputs=n.form.querySelectorAll(".popup__input"),n.submitButton=n.form.querySelector(".popup__button"),n}return t=u,(n=[{key:"close",value:function(){c(h(u.prototype),"close",this).call(this),this.form.reset()}},{key:"setInputValues",value:function(e){this.inputs.forEach((function(t){return t.value=e.get(t.id)}))}},{key:"setSubmitText",value:function(e){this.submitButton.textContent=e}},{key:"getSubmitText",value:function(){return this.submitButton.textContent}},{key:"setEventListeners",value:function(){var e=this;c(h(u.prototype),"setEventListeners",this).call(this),this.form.addEventListener("submit",(function(t){t.preventDefault(),e.submitCallback(e._getInputValues(),e)}))}},{key:"_getInputValues",value:function(){var e=new Map;return this.inputs.forEach((function(t){return e.set(t.id,t.value)})),e}}])&&l(t.prototype,n),u}(a);function v(e){return(v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e,t,n){return(y="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=k(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}})(e,t,n||e)}function _(e,t){return(_=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function b(e,t){return!t||"object"!==v(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function k(e){return(k=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var E=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_(e,t)}(u,e);var t,n,r,i,o=(r=u,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=k(r);if(i){var n=k(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return b(this,e)});function u(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(t=o.call(this,e)).viewPopupImage=t.popup.querySelector(".view-popup__image"),t.viewPopupTitle=t.popup.querySelector(".view-popup__title"),t}return t=u,(n=[{key:"open",value:function(e,t){this.viewPopupImage.src=e,this.viewPopupImage.alt=t,this.viewPopupTitle.textContent=t,y(k(u.prototype),"open",this).call(this)}}])&&m(t.prototype,n),u}(a);function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var C=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.renderer=t.renderer,this.items=t.items,this.elements=document.querySelector(n)}var t,n;return t=e,(n=[{key:"render",value:function(){var e=this;this.items.forEach((function(t){e.addItem(t)}))}},{key:"addItem",value:function(e){var t=this.renderer(e);this.elements.prepend(t)}}])&&g(t.prototype,n),e}();function w(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var S,L=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.nameElement=document.querySelector(t.nameElement),this.infoElement=document.querySelector(t.infoElement),this.avatarElement=document.querySelector(t.avatarElement)}var t,n;return t=e,(n=[{key:"getUserInfo",value:function(){return{name:this.nameElement.textContent,info:this.infoElement.textContent}}},{key:"setUserInfo",value:function(e){this.nameElement.textContent=e.name,this.infoElement.textContent=e.info}},{key:"setAvatar",value:function(e){this.avatarElement.src=e}}])&&w(t.prototype,n),e}(),I="profile-title",O="profile-subtitle",q="card-id",P=new t({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-22",headers:{authorization:"924721bb-884c-4ec6-8021-01d6ed242f97","Content-Type":"application/json"}}),T=new L({nameElement:".profile__title",infoElement:".profile__subtitle",avatarElement:".profile__avatar"}),j=new E(".view-popup"),R=new d(".profile-popup",(function(e,t){var n={name:e.get(I),info:e.get(O)};V(t,(function(){return P.setUserInfo(n).then(T.setUserInfo.bind(T))}),"Сохранение...")})),x=new d(".avatar-popup",(function(e,t){var n=e.get("profile-avatar");V(t,(function(){return P.setUserAvatar(n).then((function(){return T.setAvatar(n)}))}),"Сохранение...")})),U=new d(".commit-popup",(function(e,t){var n=e.get(q);V(t,(function(){return P.removeCard(n).then((function(){return document.querySelector("#card_"+n).remove()}))}),"Удаление...")})),B=document.querySelector(".profile__edit"),D=document.querySelector(".profile__avatar-button"),A=document.querySelector(".profile__add-button");function V(e,t,n){var r=e.getSubmitText();e.setSubmitText(n),t().then((function(){return e.close()})).catch(M).finally((function(){return e.setSubmitText(r)}))}function F(e,t){return{state:e.indexOf(t)>=0,count:e.length}}function M(e){console.log(e)}B.addEventListener("click",(function(){var e=T.getUserInfo(),t=new Map([[I,e.name],[O,e.info]]);R.setInputValues(t),R.open()})),D.addEventListener("click",(function(){return x.open()})),U.setEventListeners(),R.setEventListeners(),x.setEventListeners(),j.setEventListeners(),S={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},document.querySelectorAll(S.formSelector).forEach((function(e){new o(S,e).enableValidation()})),P.getUserInfo().then((function(e){return T.setUserInfo(e),T.setAvatar(e.avatar),e._id})).then((function(e){P.getInitialCards().then((function(t){return function(e,t){var n=new C({items:e,renderer:function(e){return function(e,t){var n={_id:e._id,name:e.name,link:e.link,likesInfo:F(e.likes,t),isDeleteEnable:e.ownerId==t},i=j.open.bind(j);return new r("#element-template",n,i,(function(e,n){return P.setCardLikeState(e._id,n).then((function(n){return e.setLikeInfo(F(n,t))})).catch(M)}),(function(e){var t=new Map([[q,e]]);U.setInputValues(t),U.open()})).render()}(e,t)}},".elements"),i=new d(".add-card-popup",(function(e,t){return function(e,t,n,r){var i={name:e.get("add-card-name"),link:e.get("add-card-link")};V(r,(function(){return P.addCard(i).then((function(e){return t.addItem(e)}))}),"Сохранение...")}(e,n,0,t)}));i.setEventListeners(),A.addEventListener("click",(function(){return i.open()})),n.render()}(t,e)})).catch(M)})).catch(M)})();